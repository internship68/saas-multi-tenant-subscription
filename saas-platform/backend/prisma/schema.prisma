generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id            String         @id @default(uuid())
  name          String
  createdAt     DateTime       @default(now())
  subscriptions Subscription[]
  users         User[]
  invitations   Invitation[]
  usages        OrganizationUsage[]
  payments      Payment[]
}

model User {
  id             String       @id
  email          String       @unique
  password       String
  name           String
  role           String
  organizationId String
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([email])
}

model Subscription {
  id                 String   @id
  organizationId     String
  plan               String
  status             String
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt          DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  payments     Payment[]

  @@index([organizationId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model Invitation {
  id             String       @id @default(uuid())
  email          String
  organizationId String
  token          String       @unique
  role           String       @default("MEMBER")
  status         String       @default("PENDING") // PENDING, ACCEPTED
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([token])
}

model AuditLog {
  id             String   @id @default(uuid())
  organizationId String
  action         String   // e.g., "SUBSCRIPTION_UPGRADED", "USER_JOINED"
  entityType     String   // e.g., "Subscription", "User"
  entityId       String
  actorId        String?  // Who performed the action (userId)
  metadata       Json?    // Store old/new values or extra info
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([entityId])
}

model OrganizationUsage {
  id             String   @id @default(uuid())
  organizationId String
  type           String   // e.g., "API_CALLS"
  currentValue   Int      @default(0)
  limit          Int
  resetAt        DateTime
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, type])
  @@index([organizationId])
}

model Payment {
  id             String   @id @default(uuid())
  organizationId String
  subscriptionId String
  amount         Float
  currency       String   @default("USD")
  status         String   // e.g., "SUCCEEDED", "FAILED", "PENDING"
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([organizationId])
  @@index([subscriptionId])
  @@index([status])
}

model ProcessedWebhookEvent {
  id          String   @id // Use Stripe Event ID
  type        String
  processedAt DateTime @default(now())
}

model IdempotencyRecord {
  id             String   @id // Idempotency-Key
  userId         String
  requestPath    String
  requestBodyHash String
  responseStatus Int
  responseBody   Json
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  @@unique([id, userId])
  @@index([expiresAt])
}
