generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id            String              @id @default(uuid())
  name          String
  createdAt     DateTime            @default(now())
  subscriptions      Subscription[]
  users              User[]
  invitations        Invitation[]
  usages             OrganizationUsage[]
  payments           Payment[]
  lineIntegrations   LineIntegration[]
  lineLeads          LineLead[]
  lineConversations  LineConversation[]
  lineMessages       LineMessage[]
  courses            Course[]
}

model User {
  id             String       @id
  email          String       @unique
  password       String
  name           String
  role           String
  organizationId String
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([email])
}

model Subscription {
  id                 String    @id
  organizationId     String
  plan               String
  status             String
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt          DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  payments     Payment[]

  @@index([organizationId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model Invitation {
  id             String       @id @default(uuid())
  email          String
  organizationId String
  token          String       @unique
  role           String       @default("MEMBER")
  status         String       @default("PENDING") // PENDING, ACCEPTED
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([token])
}

model AuditLog {
  id             String    @id @default(uuid())
  organizationId String
  action         String    // e.g., "SUBSCRIPTION_UPGRADED", "USER_JOINED"
  entityType     String    // e.g., "Subscription", "User"
  entityId       String
  actorId        String?   // Who performed the action (userId)
  metadata       Json?     // Store old/new values or extra info
  isRead         Boolean   @default(false)
  createdAt      DateTime  @default(now())

  @@index([organizationId])
  @@index([entityId])
}

model OrganizationUsage {
  id             String    @id @default(uuid())
  organizationId String
  type           String    // e.g., "API_CALLS"
  currentValue   Int       @default(0)
  limit          Int
  resetAt        DateTime
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, type])
  @@index([organizationId])
}

model Payment {
  id             String    @id @default(uuid())
  organizationId String
  subscriptionId String
  amount         Float
  currency       String    @default("USD")
  status         String    // SUCCEEDED | FAILED | PENDING
  providerPaymentId String? @unique // To prevent double payments
  createdAt      DateTime  @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([organizationId])
  @@index([subscriptionId])
  @@index([status])
}

// ─── Webhook Idempotency & DLQ ────────────────────────────────────────────────
// status: PENDING → inserted when event received by controller (pre-queue)
//         PROCESSED → updated by worker after successful processing
//         IGNORED → business rule violation (e.g. InvalidTransitionError), not retried
//         FAILED → updated by worker after all retries exhausted (Dead Letter)
model WebhookEvent {
  id              String    @id            // Stripe event ID (evt_xxx)
  type            String                   // e.g. "payment_intent.succeeded"
  status          String    @default("PENDING") // PENDING | PROCESSED | FAILED | IGNORED
  payload         Json?                    // Store parsed job payload for Replay
  receivedAt      DateTime  @default(now())
  processedAt     DateTime?
  errorMessage    String?
  failedAt        DateTime?                // When it became a Dead Letter

  @@index([status])
  @@index([receivedAt])
}

model IdempotencyRecord {
  id              String    @id            // Idempotency-Key
  userId          String
  requestPath     String
  requestBodyHash String
  responseStatus  Int
  responseBody    Json
  createdAt       DateTime  @default(now())
  expiresAt       DateTime

  @@unique([id, userId])
  @@index([expiresAt])
}

// ─── Products Layer: Line Enrollment ──────────────────────────────────────────

model LineIntegration {
  id                 String   @id @default(uuid())
  organizationId     String
  channelId          String
  channelSecret      String
  channelAccessToken String?
  webhookUrl         String?
  createdAt          DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  @@index([organizationId])
}

model LineLead {
  id             String   @id @default(uuid())
  organizationId String
  lineUserId     String
  studentName    String?
  parentName     String?
  gradeLevel     String?
  phoneNumber    String?
  interestedSubject String?
  aiConfidence   Float?
  status         String   @default("NEW") // NEW, CONTACTED, ENROLLED
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  @@index([organizationId])
  @@index([lineUserId])
}

model LineConversation {
  id             String   @id @default(uuid())
  organizationId String
  lineUserId     String
  state          String   @default("NEW") // NEW, COLLECTING_INFO, READY_TO_CONTACT, HANDOVER_TO_ADMIN
  lastIntent     String?
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  @@unique([organizationId, lineUserId])
  @@index([organizationId])
}

model LineMessage {
  id             String   @id @default(uuid())
  organizationId String
  lineUserId     String
  role           String   // "user" or "assistant"
  content        String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  @@index([organizationId])
  @@index([lineUserId])
  @@index([createdAt])
}

model Course {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  price          Float?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  @@index([organizationId])
}
